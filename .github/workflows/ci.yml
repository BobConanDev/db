name: CI
on:
  push:
  schedule:
    - cron: 13 01 * * *

# Docker image artifact uploading & downloading approach is the one suggested
# here for sharing Docker images between jobs:
# https://docs.docker.com/build/ci/github-actions/examples/#share-built-image-between-jobs

jobs:
  docker-build-cache:
    name: docker build cache
    runs-on: [linux, large, docker]
    outputs:
      docker-image: ${{ steps.build.outputs.imageid }}
    steps:
      - uses: docker/setup-buildx-action@v2.2.1
        with:
          install: true
      - uses: docker/build-push-action@v3
        id: build
        with:
          cache-from: type=gha
          cache-to: type=gha,mode=max
          tags: fluree/db
          load: true

  test-browser:
    name: test flureedb.js
    needs: docker-build-cache
    runs-on: [linux, large, docker]
    steps:
      - uses: docker/setup-buildx-action@v2.2.1
        with:
          install: true
      - uses: docker/build-push-action@v3
        with:
          cache-from: type=gha
          cache-to: type=gha,mode=max
          tags: fluree/db
          load: true
      - name: Run tests
        run: docker run fluree/db make browser-test

  test-cljs:
    name: run cljs tests
    needs: docker-build-cache
    runs-on: [linux, large, docker]
    steps:
      - uses: docker/setup-buildx-action@v2.2.1
        with:
          install: true
      - uses: docker/build-push-action@v3
        with:
          cache-from: type=gha
          cache-to: type=gha,mode=max
          tags: fluree/db
          load: true
      - name: Run tests
        run: |
          docker create --name fluree-db fluree/db
          docker cp fluree-db:/usr/src/flureedb/docker-chrome-seccomp.json .
          docker rm fluree-db
          docker run --security-opt seccomp=docker-chrome-seccomp.json fluree/db make cljstest

  test-other:
    name: run other tests
    needs: docker-build-cache
    runs-on: [linux, large, docker]
    steps:
      - uses: docker/setup-buildx-action@v2.2.1
        with:
          install: true
      - uses: docker/build-push-action@v3
        with:
          cache-from: type=gha
          cache-to: type=gha,mode=max
          tags: fluree/db
          load: true
      - name: Run tests
        run: docker run fluree/db make cljtest eastwood nodejs-test
